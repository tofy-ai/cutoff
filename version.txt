#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SH110X.h>   // use SH110X library

// ================= OLED =================
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
Adafruit_SH1106G display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1); // I2C, no reset pin

// ================= PINS =================
#define ENC_CLK 2
#define ENC_DT  3
#define ENC_SW  4     // encoder button (select mode)
#define ACT_SW  5     // external 3-way button (NC) = HOLD TO RUN
#define RELAY   6    // MOSFET / relay output

// ================= MODES =================
volatile int selectedMode = 1;
int activeMode = 1;
bool modeArmed = false;

// ================= ENCODER =================
int lastCLK;

// ================ USER TIMING =================
unsigned int mode1_on = 850, mode1_off = 400;
unsigned int mode2_on = 200, mode2_off = 150;
unsigned int mode3_on = 90, mode3_off = 125;
unsigned int mode4_on = 50, mode4_gap = 100;
unsigned int mode5_on = 100,  mode5_gap = 125;

/// ================= ENCODER ISR =================
void readEncoder() {
  int currentCLK = digitalRead(ENC_CLK);
  if (currentCLK != lastCLK) {
    if (digitalRead(ENC_DT) != currentCLK) selectedMode++;
    else selectedMode--;

    if (selectedMode > 10) selectedMode = 1;
    if (selectedMode < 1)  selectedMode = 10;
  }
  lastCLK = currentCLK;
}

// ================= ENCODER BUTTON =================
void readEncoderButton() {
  static unsigned long lastPress = 0;
  if (digitalRead(ENC_SW) == LOW && millis() - lastPress > 300) {
    activeMode = selectedMode;   // arm selected mode
    modeArmed = true;
    lastPress = millis();
  }
}

// ================= OLED =================
void drawOLED() {
  display.clearDisplay();
  display.setTextColor(SH110X_WHITE);  // use SH110X_WHITE for SH110X library

  display.setTextSize(2);
  display.setCursor(1, 1);
  display.print("1");
  display.setTextSize(2);
  display.setCursor(1, 20);
  display.print("Garage");
display.setTextSize(1);
  display.setCursor(1, 40);
  display.print("INSTA V6EAT.ER");
  display.setTextSize(1);
  display.setCursor(1, 55);
  display.print("07740863615");
  display.setTextSize(4);
  display.setCursor(80,1 );
  display.print(selectedMode);

  display.setTextSize(1);
  display.setCursor(90, 50);
  display.print(modeArmed ? "Ready" : "SEL");

  display.display();
}

// ================= RELAY BLINK =================
void blinkSimple(int onT, int offT) {
  digitalWrite(RELAY, HIGH);
  delay(onT);
  digitalWrite(RELAY, LOW);
  delay(offT);
}

// ================= SONG PATTERNS =================
void tokyoDrift() {
  blinkSimple(100, 80*2);
  blinkSimple(120, 150*3);
  blinkSimple(60, 60*2);
  delay(100);
}

void driftSong2() {
  blinkSimple(150, 150);
  blinkSimple(70, 70*3);
  blinkSimple(70, 200);
}

void driftSong3() {
  blinkSimple(50, 50*3);
  blinkSimple(200, 100);
  blinkSimple(50, 300*2);
}

void driftMega() {
  tokyoDrift();
  driftSong2();
  driftSong3();
}

// ================= SETUP =================
void setup() {
  pinMode(ENC_CLK, INPUT_PULLUP);
  pinMode(ENC_DT, INPUT_PULLUP);
  pinMode(ENC_SW, INPUT_PULLUP);
  pinMode(ACT_SW, INPUT_PULLUP);
  pinMode(RELAY, OUTPUT);

  digitalWrite(RELAY, LOW);

  lastCLK = digitalRead(ENC_CLK);
  attachInterrupt(digitalPinToInterrupt(ENC_CLK), readEncoder, CHANGE);

  Wire.begin();
  if (!display.begin(0x3C, true)) { // SH110X I2C address
    while (1); // stop here if OLED not detected
  }
  display.setRotation(0);
  display.setTextWrap(false);
  display.clearDisplay();
  display.display();
}

// ================= LOOP =================
void loop() {
  readEncoderButton();
  drawOLED();

  bool activate = (digitalRead(ACT_SW) == LOW);

  // LED MUST BE OFF unless button is held
  if (!activate || !modeArmed) {
    digitalWrite(RELAY, LOW);
    delay(50);
    return;
  }

  // Button held â†’ run mode
  switch (activeMode) {
    case 1: blinkSimple(mode1_on, mode1_off); break;
    case 2: blinkSimple(mode2_on, mode2_off); break;
    case 3: blinkSimple(mode3_on, mode3_off); break;
    case 4:
      blinkSimple(mode4_on, mode4_gap);
      blinkSimple(mode4_on, mode4_gap * 2);
      blinkSimple(mode4_on, mode4_gap * 3);
      break;
    case 5:
      blinkSimple(mode5_on, mode5_gap);
      blinkSimple(mode5_on, mode5_gap / 2);
      blinkSimple(mode5_on, mode5_gap / 3);
      break;
    case 6:
      blinkSimple(random(50, 125), random(60, 100));
      break;
    case 7: tokyoDrift(); break;
    case 8: driftSong2(); break;
    case 9: driftSong3(); break;
    case 10: driftMega(); break;
  }
}

